<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Biblioteca - Libros</title>

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f6f9;
        }
        .card {
            border-radius: 12px;
        }
        .btn-round {
            border-radius: 20px;
        }
    </style>
</head>

<body>

<!-- NAVBAR SIMPLE -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">游닄 Biblioteca</a>
        <div>
            <a href="index.html" class="btn btn-outline-light btn-sm me-2">Usuarios</a>
            <a href="libros.html" class="btn btn-light btn-sm me-2">Libros</a>
            <a href="prestamos.html" class="btn btn-outline-light btn-sm">Pr칠stamos</a>
        </div>
    </div>
</nav>


<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold">Gesti칩n de Libros</h3>
        <button class="btn btn-primary btn-round" data-bs-toggle="modal" data-bs-target="#modalCrearLibro">+ Agregar Libro</button>
    </div>

    <!-- TABLA LIBROS -->
    <div class="card shadow">
        <div class="card-body">
            <table class="table table-striped" id="tablaLibros">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>T칤tulo</th>
                        <th>Autor</th>
                        <th>A침o</th>
                        <th>Categor칤a</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>




<!-- ============================
   MODAL CREAR LIBRO
============================ -->
<div class="modal fade" id="modalCrearLibro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Libro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="formCrearLibro">

                    <div class="mb-2">
                        <label>T칤tulo</label>
                        <input type="text" class="form-control" name="titulo" required>
                    </div>

                    <div class="mb-2">
                        <label>Autor</label>
                        <input type="text" class="form-control" name="autor" required>
                    </div>

                    <div class="mb-2">
                        <label>A침o</label>
                        <input type="number" class="form-control" name="anio" required>
                    </div>

                    <div class="mb-2">
                        <label>Categor칤a</label>
                        <input type="text" class="form-control" name="categoria" required>
                    </div>

                    <div class="mb-2">
                        <label>Stock</label>
                        <input type="number" class="form-control" name="stock" required>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" form="formCrearLibro" class="btn btn-primary">Guardar</button>
            </div>

        </div>
    </div>
</div>






<!-- ============================
   MODAL EDITAR LIBRO
============================ -->
<div class="modal fade" id="modalEditarLibro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-warning">
                <h5 class="modal-title">Editar Libro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="formEditarLibro">

                    <input type="hidden" name="id_libro">

                    <div class="mb-2">
                        <label>T칤tulo</label>
                        <input type="text" class="form-control" name="titulo" required>
                    </div>

                    <div class="mb-2">
                        <label>Autor</label>
                        <input type="text" class="form-control" name="autor" required>
                    </div>

                    <div class="mb-2">
                        <label>A침o</label>
                        <input type="number" class="form-control" name="anio" required>
                    </div>

                    <div class="mb-2">
                        <label>Categor칤a</label>
                        <input type="text" class="form-control" name="categoria" required>
                    </div>

                    <div class="mb-2">
                        <label>Stock</label>
                        <input type="number" class="form-control" name="stock" required>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" form="formEditarLibro" class="btn btn-warning">Actualizar</button>
            </div>

        </div>
    </div>
</div>





<!-- BOOTSTRAP + JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API = "http://localhost/SISTEMA_BIBLIOTECA/api/biblioteca.php";


// ===============================
//  CARGAR TABLA
// ===============================
function cargarLibros() {
    fetch(API + "?action=mostrar_libros")
        .then(r => {
            if (!r.ok) throw new Error("Error en la red: " + r.statusText);
            return r.json();
        })
        .then(data => {
            let tabla = "";
            data.data.forEach(libro => {
                tabla += `
                    <tr>
                        <td>${libro.id_libro}</td>
                        <td>${libro.titulo}</td>
                        <td>${libro.autor}</td>
                        <td>${libro.anio}</td>
                        <td>${libro.categoria}</td>
                        <td>${libro.stock}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="abrirEditar(${libro.id_libro})">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarLibro(${libro.id_libro})">Eliminar</button>
                        </td>
                    </tr>
                `;
            });
            document.querySelector("#tablaLibros tbody").innerHTML = tabla;
        })
        .catch(error => {
            console.error('Error al cargar libros:', error);
            alert("No se pudieron cargar los libros. Revise la conexi칩n con la API.");
        });
}

cargarLibros();

// ===============================
//  EVENT LISTENER PARA CREAR LIBRO
// ===============================
document.getElementById("formCrearLibro").addEventListener("submit", function(e) {
    e.preventDefault();
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalCrearLibro'));
    let formData = new FormData(this);
    formData.append("action", "crear_libro");

    fetch(API, { method: "POST", body: formData })
        .then(r => r.json())
        .then(resp => {
            alert(resp.message);
            if (resp.success) {
                this.reset();
                modal.hide();
                cargarLibros();
            }
        })
        .catch(error => {
            console.error('Error al crear libro:', error);
            alert("Error de conexi칩n al crear el libro.");
        });
});


// ===============================
//  ABRIR MODAL EDITAR
// ===============================
function abrirEditar(id) {
    fetch(API + "?action=obtener_libro&id_libro=" + id)
        .then(r => r.json())
        .then(resp => {
            if (!resp.success) return alert("Libro no encontrado.");

            let form = document.getElementById("formEditarLibro");
            form.id_libro.value = resp.data.id_libro;
            form.titulo.value = resp.data.titulo;
            form.autor.value = resp.data.autor;
            form.anio.value = resp.data.anio;
            form.categoria.value = resp.data.categoria;
            form.stock.value = resp.data.stock;

            new bootstrap.Modal(document.getElementById("modalEditarLibro")).show();
        });
}


// ===============================
//  EVENT LISTENER PARA ACTUALIZAR LIBRO
// ===============================
document.getElementById("formEditarLibro").addEventListener("submit", function(e) {
    e.preventDefault();
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalEditarLibro'));
    let formData = new FormData(this);
    formData.append("action", "editar_libro");

    fetch(API, { method: "POST", body: formData })
        .then(r => r.json())
        .then(resp => {
            alert(resp.message);
            if (resp.success) {
                modal.hide();
                cargarLibros();
            }
        }).catch(error => {
            console.error('Error al actualizar libro:', error);
            alert("Error de conexi칩n al actualizar el libro.");
        })
        .catch(error => {
            console.error('Error al actualizar libro:', error);
            alert("Error de conexi칩n al actualizar el libro.");
        });
});


// ===============================
//  ELIMINAR
// ===============================
function eliminarLibro(id) {
    if (!confirm("쮼liminar este libro?")) return;

    let formData = new FormData();
    formData.append("action", "eliminar_libro");
    formData.append("id_libro", id);

    fetch(API, { method: "POST", body: formData })
        .then(r => r.json())
        .then(resp => {
            alert(resp.message);
            cargarLibros();
        })
        .catch(error => {
            console.error('Error al eliminar libro:', error);
            alert("Error de conexi칩n al eliminar el libro.");
        });
}

</script>

</body>
</html>
